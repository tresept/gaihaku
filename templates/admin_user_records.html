<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ユーザー記録の編集</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container-main { padding-top: 2rem; padding-bottom: 2rem; }
        .table-responsive { margin-top: 1rem; }
        td { vertical-align: middle; text-align: center; }
        @media (max-width: 767.98px) { .table-responsive { display: none; } }
        @media (min-width: 768px) { .card-responsive { display: none; } }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/admin">管理ダッシュボード</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link" href="/admin/add_user">ユーザー追加</a></li>
            </ul>
            <ul class="navbar-nav"><li class="nav-item"><a class="nav-link" href="/logout">ログアウト</a></li></ul>
        </div>
    </div>
</nav>

<div class="container container-main">
    <h3 class="text-center mb-4">ユーザー記録の編集: {{.studentID}}</h3>
    {{if .successMessage}}
        <div class="alert alert-success" role="alert">{{.successMessage}}</div>
    {{end}}

    <form action="/admin/user/{{.studentID}}" method="post" class="d-none d-md-block" onsubmit="return confirm('登録を完了しますか？');">
        <div class="table-responsive">
            <table class="table table-hover table-bordered align-middle text-center">
                <thead class="table-light">
                    <tr>
                        <th scope="col">日付</th>
                        <th scope="col">朝食</th>
                        <th scope="col">昼食</th>
                        <th scope="col">夕食</th>
                        <th scope="col">外泊</th>
                        <th scope="col">備考</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .records}}
                    <tr>
                        <th scope="row">{{.RecordDate.Format "2006/01/02"}}</th>
                        <td>
                            <button type="button" class="btn {{if .Breakfast}}btn-success{{else}}btn-outline-danger{{end}}" data-toggle="button" data-date="{{.RecordDate.Format "2006-01-02"}}" data-meal="breakfast" aria-pressed="{{.Breakfast}}" autocomplete="off">
                                <i class="bi {{if .Breakfast}}bi-check-lg{{else}}bi-x-lg{{end}}"></i>
                            </button>
                            <input type="hidden" name="breakfast-{{.RecordDate.Format "2006-01-02"}}" value="{{if not .Breakfast}}on{{end}}">
                        </td>
                        <td>
                            <button type="button" class="btn {{if .Lunch}}btn-success{{else}}btn-outline-danger{{end}}" data-toggle="button" data-date="{{.RecordDate.Format "2006-01-02"}}" data-meal="lunch" aria-pressed="{{.Lunch}}" autocomplete="off">
                                <i class="bi {{if .Lunch}}bi-check-lg{{else}}bi-x-lg{{end}}"></i>
                            </button>
                            <input type="hidden" name="lunch-{{.RecordDate.Format "2006-01-02"}}" value="{{if not .Lunch}}on{{end}}">
                        </td>
                        <td>
                            <button type="button" class="btn {{if .Dinner}}btn-success{{else}}btn-outline-danger{{end}}" data-toggle="button" data-date="{{.RecordDate.Format "2006-01-02"}}" data-meal="dinner" aria-pressed="{{.Dinner}}" autocomplete="off">
                                <i class="bi {{if .Dinner}}bi-check-lg{{else}}bi-x-lg{{end}}"></i>
                            </button>
                            <input type="hidden" name="dinner-{{.RecordDate.Format "2006-01-02"}}" value="{{if not .Dinner}}on{{end}}">
                        </td>
                        <td>
                            <button type="button" class="btn {{if .Overnight}}btn-success{{else}}btn-outline-danger{{end}}" data-toggle="button" data-date="{{.RecordDate.Format "2006-01-02"}}" data-meal="overnight" aria-pressed="{{.Overnight}}" autocomplete="off">
                                <i class="bi {{if .Overnight}}bi-check-lg{{else}}bi-x-lg{{end}}"></i>
                            </button>
                            <input type="hidden" name="overnight-{{.RecordDate.Format "2006-01-02"}}" value="{{if .Overnight}}on{{end}}">
                        </td>
                        <td>
                            <input type="text" class="form-control" name="note-{{.RecordDate.Format "2006-01-02"}}" value="{{.Note}}">
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
            <button type="submit" class="btn btn-primary btn-lg">登録</button>
        </div>
    </form>

    <!-- I will omit the responsive card view for now to keep it simple -->

</div>
<script>
    // This script is identical to the one in main.html
    document.addEventListener('DOMContentLoaded', function() {
        const toggleButtons = document.querySelectorAll('[data-toggle="button"]');
        toggleButtons.forEach(button => {
            const date = button.getAttribute('data-date');
            const meal = button.getAttribute('data-meal');
            let hiddenInput = document.querySelector(`input[name="${meal}-${date}"]`);

            if (!hiddenInput) {
                hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = `${meal}-${date}`;
                button.parentNode.appendChild(hiddenInput);
            }

            // This logic is tricky. The value should be 'on' when the meal is SKIPPED.
            // So if Breakfast is true (not skipped), the value is empty. If Breakfast is false (skipped), value is 'on'.
            // Overnight is the opposite. If Overnight is true, value is 'on'.
            if (meal === 'overnight') {
                hiddenInput.value = button.getAttribute('aria-pressed') === 'true' ? 'on' : '';
            } else {
                hiddenInput.value = button.getAttribute('aria-pressed') === 'true' ? '' : 'on';
            }

            button.addEventListener('click', function() {
                const isPressed = this.getAttribute('aria-pressed') === 'true';
                const newPressedState = !isPressed;

                this.setAttribute('aria-pressed', String(newPressedState));
                this.classList.toggle('btn-success', newPressedState);
                this.classList.toggle('btn-outline-danger', !newPressedState);
                this.querySelector('i').classList.toggle('bi-check-lg', newPressedState);
                this.querySelector('i').classList.toggle('bi-x-lg', !newPressedState);

                if (meal === 'overnight') {
                    hiddenInput.value = newPressedState ? 'on' : '';
                } else {
                    hiddenInput.value = newPressedState ? '' : 'on';
                }
            });
        });
    });
</script>
</body>
</html>
